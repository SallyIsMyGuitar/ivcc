package charger

import (
	"bytes"
	"testing"

	"github.com/andig/evcc/util"
)

func TestTPLink(t *testing.T) {

	c := &TPLink{
		log: util.NewLogger("tplink"),
	}

	// Test TP-Link Smart-Home protocol command encryption
	tplcmd := `{"emeter":{"get_realtime":null}}`
	tplcmdd := []byte{0x00, 0x00, 0x00, 0x20, 0xd0, 0xf2, 0x97, 0xfa, 0x9f, 0xeb, 0x8e, 0xfc, 0xde, 0xe4, 0x9f, 0xbd, 0xda, 0xbf, 0xcb, 0x94, 0xe6, 0x83, 0xe2, 0x8e, 0xfa, 0x93, 0xfe, 0x9b, 0xb9, 0x83, 0xed, 0x98, 0xf4, 0x98, 0xe5, 0x98}

	if res := bytes.Compare(c.encode(tplcmd).Bytes(), tplcmdd); res != 0 {
		t.Error("TP-Link command encode")
	}

	// Test TP-Link Smart-Home protocol response encryption
	tplrespd := []byte{0x00, 0x00, 0x00, 0x6d, 0xd0, 0xf2, 0x97, 0xfa, 0x9f, 0xeb, 0x8e, 0xfc, 0xde, 0xe4, 0x9f, 0xbd, 0xda, 0xbf, 0xcb, 0x94, 0xe6, 0x83, 0xe2, 0x8e, 0xfa, 0x93, 0xfe, 0x9b, 0xb9, 0x83, 0xf8, 0xda, 0xb9, 0xcc, 0xbe, 0xcc, 0xa9, 0xc7, 0xb3, 0x91, 0xab, 0x9b, 0xb5, 0x85, 0xb4, 0x82, 0xba, 0x89, 0xb9, 0x95, 0xb7, 0xc1, 0xae, 0xc2, 0xb6, 0xd7, 0xb0, 0xd5, 0xf7, 0xcd, 0xff, 0xcc, 0xf9, 0xd7, 0xee, 0xd6, 0xe4, 0xd7, 0xe6, 0xd3, 0xff, 0xdd, 0xad, 0xc2, 0xb5, 0xd0, 0xa2, 0x80, 0xba, 0x8a, 0xa6, 0x84, 0xf0, 0x9f, 0xeb, 0x8a, 0xe6, 0xc4, 0xfe, 0xce, 0xe0, 0xd0, 0xe3, 0xd5, 0xe5, 0xd5, 0xe5, 0xc9, 0xeb, 0x8e, 0xfc, 0x8e, 0xd1, 0xb2, 0xdd, 0xb9, 0xdc, 0xfe, 0xc4, 0xf4, 0x89, 0xf4, 0x89}
	tplresp := []byte(`{"emeter":{"get_realtime":{"current":0.016830,"voltage":235.982315,"power":0,"total":0.036000,"err_code":0}}}`)

	if res := bytes.Compare(c.decode(tplrespd), []byte(tplresp)); res != 0 {
		t.Error("TP-Link response decode")
	}

}
