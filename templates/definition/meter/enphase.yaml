template: enphase
products:
  - brand: Enphase
    description:
      generic: IQ Envoy
params:
  - name: usage
    choice: ["grid", "pv"]
  - name: host
    required: true
  - name: token
render: |
  type: custom
  {{- if eq .usage "grid" }}
  power:
    source: http
    uri: http://{{ .host }}/production.json
    method: GET
    {{- if .token }}
    auth:
      type: bearer
      password: {{ .token }}
    insecure: true
    {{- end }}
    jq: .consumption[] | select(.measurementType == "net-consumption").wNow
    scale: 1
  {{- end }}
  {{- if eq .usage "pv" }}
  power:
    source: http
    uri: http://{{ .host }}/production.json
    method: GET
    {{- if .token }}
    auth:
      type: bearer
      password: {{ .token }}
    insecure: true
    {{- end }}
    jq: .production[] | select(.measurementType == "production").wNow
    scale: 1
  {{- end }}
