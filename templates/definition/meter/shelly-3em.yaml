template: shelly-3em
products:
  - brand: Shelly
    description:
      generic: 3EM
params:
  - name: usage
    choice: ["grid", "pv", "charge"]
  - name: host
render: |
  type: custom
  power:
    source: http
    uri: http://{{ .host }}/status
    jq: .emeters | map(.power) | add
  {{- if or (eq .usage "charge") (eq .usage "grid") }}
  energy:
    source: http
    uri: http://{{ .host }}/status
    jq: .emeters | map(.total) | add
    scale: 0.001
  {{ end -}}
  {{if ne .usage "pv" -}}
  {{if eq .usage "grid" -}}
  currents:
  - source: http
    uri: http://{{ .host }}/emeter/0
    jq: if .power < 0 then - .current else .current end
  - source: http
    uri: http://{{ .host }}/emeter/1
    jq: if .power < 0 then - .current else .current end
  - source: http
    uri: http://{{ .host }}/emeter/2
    jq: if .power < 0 then - .current else .current end
  {{ else }}
  currents:
  - source: http
    uri: http://{{ .host }}/emeter/0
    jq: .current
  - source: http
    uri: http://{{ .host }}/emeter/1
    jq: .current
  - source: http
    uri: http://{{ .host }}/emeter/2
    jq: .current
  {{ end -}}
  {{ end -}}
