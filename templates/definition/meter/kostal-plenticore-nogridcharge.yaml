template: kostal-plenticore-nogridcharge
products:
  - brand: Kostal
    description:
      generic: Plenticore Hybrid (Gen.1+)
capabilities: ["battery-control"]
requirements:
  description:
    de: |
      Nur ein System kann und darf auf den Wechselrichter zugreifen! Für die aktive Batteriesteuerung muss die externe Batteriesteuerung über Modbus mit dem Handwerkerzugang aktiviert sein. Die Netzladung steht in diesem Template nicht zur Verfügung. Kompatibel auch mit Gen.1 Wechselrichtern.
    en: |
      Only a single system may access the inverter! For active battery control, the external battery control via Modbus must be activated using installer access. The function for grid charging the battery is not possible with this template. Compatibilty also with gen.1 inverters.
params:
  - name: usage
    choice: ["battery"]
  - name: modbus
    choice: ["tcpip"]
    id: 71
    port: 1502
  - name: endianness
    description:
      de: Byte-Reihenfolge (Little/Big)
      en: Endianness (Little/Big)
    validvalues: ["big", "little"]
    default: little
    advanced: true
  - name: capacity
    advanced: true
  # battery control
  - name: minsoc
    type: number
    advanced: true
  - name: maxsoc
    type: number
    advanced: true
  - name: watchdog
    type: duration
    default: 60s
    advanced: true
render: |
  type: custom
  power:
    source: sunspec
    {{- include "modbus" . | indent 2 }}
    value: 802:W # 802 battery control
  soc:
    source: sunspec
    {{- include "modbus" . | indent 2 }}
    value: 802:SoC # 802 battery control
  limitsoc:
    source: watchdog
    timeout: {{ .watchdog }} # re-write at timeout/2
    set:
      source: modbus
      {{- include "modbus" . | indent 4 }}
      register:
        address: 1042 # limit soc
        type: writemultiple
        encoding: {{ if (eq .endianness "big") }}float32{{ else }}float32s{{ end }}
  capacity: {{ .capacity }} # kWh
  minsoc: {{ .minsoc }} # %
  maxsoc: {{ .maxsoc }} # %
